<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-translate="D2B1 - Secure Administration">D2B1 - Secure Administration</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #e0eafc, #cfdef3);
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .card {
            background: white;
            padding: 30px;
            margin: 20px auto;
            max-width: 650px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            box-sizing: border-box;
        }
        h1, h3, h4 {
            text-align: center;
            color: #004080;
            margin-bottom: 25px;
        }

        input[type="password"],
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px 15px;
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 16px;
            box-sizing: border-box;
            border: 1px solid #c0d0e0;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        button {
            flex-grow: 1;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-align: center;
            white-space: nowrap;
            box-sizing: border-box;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-danger:hover { background-color: #c0392b; }

        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }

        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #545b62; }

        #mainCard button,
        #superviseurContainer button,
        .teamleaders button,
        .rotation-calculator-section button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            margin-top: 0;
        }
        #addParticipantInRotationBtn {
            background-color: #28a745;
            color: white;
        }
        #addParticipantInRotationBtn:hover {
            background-color: #218838;
        }

        .button-group button {
            margin-top: 0;
            margin-bottom: 0;
        }

        #passwordStrengthMessage {
            text-align: left;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #004080;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) { background-color: #f8f8f8; }

        .table-actions {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .table-actions button {
            padding: 5px 8px;
            font-size: 0.8em;
            margin: 0;
            width: auto;
            display: inline-block;
        }
        .payment-validated {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        .payment-pending {
            background-color: #f8d7da;
            color: #721c24;
        }


        @media (max-width: 600px) {
            input, button, select { font-size: 14px; padding: 10px; }
            table { font-size: 0.8em; }
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
        }
        #forgotSection {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            cursor: pointer;
            text-decoration: underline;
        }
        #forgotSection:hover {
            color: #007bff;
        }
        .alert-red { color: red; font-weight: bold; }

        .language-selector {
            margin-bottom: 20px;
            text-align: right;
        }
        .language-selector select {
            width: auto;
            display: inline-block;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<script>
    emailjs.init("2hThAT8H9CsDcLLE1");

    let otpCode = "";
    const SECURE_ADMIN_PASSWORD = "D2B1@dmin2025";
    let participants = []; // Global array to hold all participants

    // Rotation specific state variables
    let rotationMembersQueue = []; // Temporarily holds participants for the current 10-person or 2-person batch
    let rolloverFund = 0; // Amount that carries over from previous rotation

    // --- Language Translation Data ---
    const translations = {
        en: {
            // General
            "D2B1 - Secure Administration": "D2B1 - Secure Administration",
            "D2B1 - Participant Management": "D2B1 - Participant Management",
            "Secure Admin Space": "Secure Admin Space",
            "Admin Password": "Admin Password",
            "Show/Hide": "üëÅÔ∏è Show/Hide",
            "Login": "üîê Login",
            "Forgot password?": "Forgot password?",
            "Please contact administrator to reset your password.": "Please contact administrator to reset your password.",
            "Incorrect password": "Incorrect password",
            "OTP code sent to your email.": "üì§ OTP code sent to your email.",
            "Enter OTP code": "Enter OTP code",
            "Verify": "‚úÖ Verify",
            "Invalid verification code": "Invalid verification code",
            "Password correct.": "Password correct.",
            "Strong password (but incorrect).": "Strong password (but incorrect).",
            "Password must contain at least 8 characters, including one uppercase, one lowercase, one number, and one special character.": "Password must contain at least 8 characters, including one uppercase, one lowercase, one number, and one special character.",
            "Error sending Email:": "Error sending Email:",
            "Action 'Next Day' executed. (Full functionality requires a backend)": "Action 'Next Day' executed. (Full functionality requires a backend)",
            "No data to export.": "No data to export.",
            "ATTENTION: This will erase ALL participant data. Are you sure?": "ATTENTION: This will erase ALL participant data. Are you sure?",
            "All participant data has been reset.": "All participant data has been reset.",
            "Add Supervisor": "Add Supervisor",
            "Supervisor +1": "üë®‚Äçüíº Supervisor +1",
            "Supervisor Name": "Supervisor Name",
            "Request Reset": "üóëÔ∏è Request Reset",
            "Request Logout": "üö™ Request Logout",
            "Team Leader Name": "Team Leader Name",
            "Participant Name": "Participant Name",
            "Add": "‚ûï Add",
            "Validate Payment": "‚úÖ Validate Payment",
            "Next Day": "üîÅ Next Day",
            "Export": "üì§ Export",
            "Request for reset sent to administrator": "Request for reset sent to administrator",
            "Request for logout sent to administrator": "Request for logout sent to administrator",
            "No participant recorded.": "No participant recorded.",
            "Please fill all fields (Name, Investment, Gain, Date) with valid values.": "Please fill all fields (Name, Investment, Gain, Date) with valid values.",
            "Are you sure you want to delete this participant?": "Are you sure you want to delete this participant?",
            "Cancel Payment": "Cancel Payment",
            "Delete": "Delete",

            // Main Card specific
            "Add Participant (Normal)": "‚ûï Add Participant (Normal)",
            "Investment (‚Ç¨)": "Investment (‚Ç¨)",
            "Gain (‚Ç¨)": "Gain (‚Ç¨)",
            "Participant History": "Participant History",
            "Payment Validated": "Payment Validated",
            "Yes": "Yes",
            "No": "No",
            "Total (‚Ç¨)": "Total (‚Ç¨)",
            "Actions": "Actions",
            "Export History": "üì§ Export History",
            "Reset Data": "üóëÔ∏è Reset Data",
            "Logout": "üö™ Logout",
            "Participant Name (for TL)": "Participant Name (for TL)",
            "Payment Method": "Payment Method",
            "N¬∞": "N¬∞",
            "Name": "Name",
            "Date": "Date",

            // New rotation specific
            "Rotation Gain Calculator": "Rotation Gain Calculator",
            "Total Investment (for 10 participants)": "Total Investment (for 10 participants)",
            "Calculated Gain (for Winner)": "Calculated Gain (for Winner)",
            "Calculate Gain": "üßÆ Calculate Gain",
            "Add Participant in Rotation": "üîÑ Add Participant in Rotation",
            "Participant added to rotation. Current count:": "Participant added to rotation. Current count:",
            "Winner! Gain for this rotation:": "Winner! Gain for this rotation:",
            "No winner this time.": "No winner this time.",
            "Must be a number 10 or more.": "Must be a number 10 or more.",
            "Please fill all fields (Name, Investment, Date) with valid values.": "Please fill all fields (Name, Investment, Date) with valid values.",
            " for this winner cycle.": " for this winner cycle."
        },
        fr: {
            // General
            "D2B1 - Secure Administration": "D2B1 - Authentification S√©curis√©e",
            "D2B1 - Participant Management": "D2B1 - Gestion des Participants",
            "Secure Admin Space": "Espace Admin S√©curis√©",
            "Admin Password": "Mot de passe admin",
            "Show/Hide": "üëÅÔ∏è Afficher/Cacher",
            "Login": "üîê Connexion",
            "Forgot password?": "Mot de passe oubli√© ?",
            "Please contact administrator to reset your password.": "Veuillez contacter l'administrateur pour r√©initialiser votre mot de passe.",
            "Incorrect password": "Mot de passe incorrect",
            "OTP code sent to your email.": "üì§ Code OTP envoy√© √† votre email.",
            "Enter OTP code": "Entrez le code OTP",
            "Verify": "‚úÖ V√©rifier",
            "Invalid verification code": "Code de v√©rification invalide",
            "Password correct.": "Mot de passe correct.",
            "Strong password (but incorrect).": "Mot de passe fort (mais incorrect).",
            "Password must contain at least 8 characters, including one uppercase, one lowercase, one number, and one special character.": "Le mot de passe doit contenir au moins 8 caract√®res, dont une majuscule, une minuscule, un chiffre et un caract√®re sp√©cial.",
            "Error sending Email:": "Erreur envoi Email:",
            "Action 'Next Day' executed. (Full functionality requires a backend)": "Action 'Jour Suivant' ex√©cut√©e. (Fonctionnalit√© compl√®te n√©cessite un backend)",
            "No data to export.": "Aucune donn√©e √† exporter.",
            "ATTENTION: This will erase ALL participant data. Are you sure?": "ATTENTION : Ceci effacera TOUTES les donn√©es des participants. √ätes-vous s√ªr ?",
            "All participant data has been reset.": "Toutes les donn√©es des participants ont √©t√© r√©initialis√©es.",
            "Add Supervisor": "Ajouter un Superviseur",
            "Supervisor +1": "üë®‚Äçüíº Superviseur +1",
            "Supervisor Name": "Nom du superviseur",
            "Request Reset": "üóëÔ∏è Demande R√©initialiser",
            "Request Logout": "üö™ Demande D√©connexion",
            "Team Leader Name": "Nom du team leader",
            "Participant Name": "Nom du participant",
            "Add": "‚ûï Ajouter",
            "Validate Payment": "‚úÖ Valider Paiement",
            "Next Day": "üîÅ Jour Suivant",
            "Export": "üì§ Export",
            "Request for reset sent to administrator": "Demande de r√©initialisation envoy√©e √† l‚Äôadministrateur",
            "Request for logout sent to administrator": "Demande de d√©connexion envoy√©e √† l‚Äôadministrateur",
            "No participant recorded.": "Aucun participant enregistr√©.",
            "Please fill all fields (Name, Investment, Gain, Date) with valid values.": "Veuillez remplir tous les champs (Nom, Investissement, Gain, Date) avec des valeurs valides.",
            "Are you sure you want to delete this participant?": "√ätes-vous s√ªr de vouloir supprimer ce participant ?",
            "Cancel Payment": "Annuler Paiement",
            "Delete": "Supprimer",

            // Main Card specific
            "Add Participant (Normal)": "‚ûï Ajouter Participant (Normal)",
            "Investment (‚Ç¨)": "Investissement (‚Ç¨)",
            "Gain (‚Ç¨)": "Gain (‚Ç¨)",
            "Participant History": "Historique des Participants",
            "Payment Validated": "Paiement Valid√©",
            "Yes": "Oui",
            "No": "Non",
            "Total (‚Ç¨)": "Total (‚Ç¨)",
            "Actions": "Actions",
            "Export History": "üì§ Export Historique",
            "Reset Data": "üóëÔ∏è R√©initialiser Donn√©es",
            "Logout": "üö™ D√©connexion",
            "Participant Name (for TL)": "Nom du participant (pour TL)",
            "Payment Method": "M√©thode de Paiement",
            "N¬∞": "N¬∞",
            "Name": "Nom",
            "Date": "Date",

            // New rotation specific
            "Rotation Gain Calculator": "Calculateur de Gain de Rotation",
            "Total Investment (for 10 participants)": "Investissement Total (pour 10 participants)",
            "Calculated Gain (for Winner)": "Gain Calcul√© (pour le Gagnant)",
            "Calculate Gain": "üßÆ Calculer le Gain",
            "Add Participant in Rotation": "üîÑ Ajouter Participant en Rotation",
            "Participant added to rotation. Current count:": "Participant ajout√© √† la rotation. Compte actuel :",
            "Winner! Gain for this rotation:": "Gagnant ! Gain pour cette rotation :",
            "No winner this time.": "Pas de gagnant cette fois-ci.",
            "Must be a number 10 or more.": "Doit √™tre un nombre de 10 ou plus.",
            "Please fill all fields (Name, Investment, Date) with valid values.": "Veuillez remplir tous les champs (Nom, Investissement, Date) avec des valeurs valides.",
            " for this winner cycle.": " pour ce cycle de gagnant."
        }
    };

    let currentLanguage = localStorage.getItem('language') || 'en';

    function setLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        applyTranslations();
    }

    function translateText(key) {
        return translations[currentLanguage][key] || key;
    }

    function applyTranslations() {
        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.getAttribute('data-translate');
            element.textContent = translateText(key);
        });

        document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
            const key = element.getAttribute('data-translate-placeholder');
            element.placeholder = translateText(key);
        });

        document.querySelectorAll('[data-translate-value]').forEach(element => {
            const key = element.getAttribute('data-translate-value');
            element.value = translateText(key);
        });

        document.title = translateText(document.title);
        if (document.getElementById('mainCard')) {
            document.getElementById('mainCard').querySelector('h3').textContent = translateText("D2B1 - Participant Management");
        }
        if (document.getElementById('authCard')) {
            document.getElementById('authCard').querySelector('h1').textContent = translateText("Secure Admin Space");
        }
        if (document.getElementById('historyTable')) {
            document.getElementById('historyTable').querySelector('h4').textContent = translateText("Participant History");
        }
        if (document.getElementById('superviseurContainer')) {
             document.getElementById('superviseurContainer').querySelector('h3').textContent = translateText("Add Supervisor");
        }
        if (document.getElementById('rotationCalculatorSection')) {
            document.getElementById('rotationCalculatorSection').querySelector('h4').textContent = translateText("Rotation Gain Calculator");
        }

        renderParticipantsTable(); // Re-render table to apply translations to dynamic content
    }

    // --- Data Storage and Management ---
    document.addEventListener('DOMContentLoaded', () => {
        loadParticipants();
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById("participantDate");
        if (dateInput) {
            dateInput.value = today;
        }

        const investmentInput = document.getElementById("participantInvestment");
        if (investmentInput) {
            investmentInput.addEventListener("keyup", calculateGainOnEnter);
        }

        const rotationInvestmentInput = document.getElementById("rotationTotalInvestment");
        if (rotationInvestmentInput) {
            rotationInvestmentInput.addEventListener("keyup", (event) => {
                if (event.key === "Enter") {
                    calculateRotationGain();
                }
            });
        }

        const langSelector = document.getElementById('languageSelector');
        if (langSelector) {
            langSelector.value = currentLanguage;
            langSelector.addEventListener('change', (event) => {
                setLanguage(event.target.value);
            });
        }
        applyTranslations();
    });

    function saveParticipants() {
        localStorage.setItem('d2b1_participants', JSON.stringify(participants));
        localStorage.setItem('rotationMembersQueue', JSON.stringify(rotationMembersQueue));
        localStorage.setItem('rolloverFund', rolloverFund);
    }

    function loadParticipants() {
        const storedParticipants = localStorage.getItem('d2b1_participants');
        if (storedParticipants) {
            participants = JSON.parse(storedParticipants);
        } else {
            participants = [];
        }

        const storedRotationQueue = localStorage.getItem('rotationMembersQueue');
        if (storedRotationQueue) {
            rotationMembersQueue = JSON.parse(storedRotationQueue);
        } else {
            rotationMembersQueue = [];
        }

        rolloverFund = parseFloat(localStorage.getItem('rolloverFund') || '0');

        renderParticipantsTable();
    }

    function renderParticipantsTable() {
        const tableBody = document.getElementById('participantsTableBody');
        if (!tableBody) return;

        tableBody.innerHTML = '';

        if (participants.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" data-translate="No participant recorded.">${translateText("No participant recorded.")}</td></tr>`;
            return;
        }

        participants.forEach((p, index) => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${p.name}</td>
                <td class="${p.paymentValidated ? 'payment-validated' : 'payment-pending'}">
                    ${p.paymentValidated ? translateText('Yes') : translateText('No')}
                </td>
                <td>${p.investment.toFixed(2)}</td>
                <td>${p.gain.toFixed(2)}</td>
                <td>${p.date}</td>
                <td>${(p.investment + p.gain).toFixed(2)}</td>
                <td>${p.paymentMethod}</td>
                <td class="table-actions">
                    <button onclick="togglePaymentValidation(${index})" class="${p.paymentValidated ? 'btn-secondary' : 'btn-primary'}">
                        ${p.paymentValidated ? translateText('Cancel Payment') : translateText('Validate Payment')}
                    </button>
                    <button onclick="deleteParticipant(${index})" class="btn-danger">${translateText('Delete')}</button>
                </td>
            `;
        });
    }

    // --- Authentication Functions ---
    function isValidAdminPassword(password) {
        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+])[A-Za-z\d!@#$%^&*()_+]{8,}$/;
        return regex.test(password);
    }

    function sendOTPByEmail(code) {
        const expiryTime = new Date();
        expiryTime.setMinutes(expiryTime.getMinutes() + 15);
        const options = { hour: 'numeric', minute: 'numeric', hour12: true, month: 'long', day: 'numeric', year: 'numeric' };
        const formattedExpiryTime = expiryTime.toLocaleString('en-US', options);

        emailjs.send("service_3gm6ixa", "template_s0v58wk", {
            to_name: "Emmanuel",
            to_email: "emmanueljeambas@gmail.com",
            message: translateText("OTP code sent to your email.") + " " + code,
            passcode: code,
            time: formattedExpiryTime
        }).then(() => console.log(translateText("OTP code sent to your email.")))
        .catch(err => alert(translateText("Error sending Email:") + " " + err.text));
    }

    function checkAdminStep1() {
        const pass = document.getElementById("adminPass").value;
        if (pass === SECURE_ADMIN_PASSWORD) {
            otpCode = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById("authCard").style.display = "none";
            document.getElementById("codeCard").style.display = "block";
            sendOTPByEmail(otpCode);
        } else {
            alert(translateText("Incorrect password"));
        }
    }

    function toggleVisibility(id) {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
    }

    function checkAdminStep2() {
        const code = document.getElementById("code2FA").value.trim();
        if (code === otpCode) {
            document.getElementById("codeCard").style.display = "none";
            document.getElementById("mainCard").style.display = "block";
            document.getElementById("superviseurContainer").style.display = "block";
            renderParticipantsTable();
        } else {
            alert(translateText("Invalid verification code"));
        }
    }

    // --- Main Admin Actions (Participant Management) ---
    function addParticipant() {
        const name = document.getElementById("participantName").value.trim();
        const investment = parseFloat(document.getElementById("participantInvestment").value);
        const gain = parseFloat(document.getElementById("participantGain").value);
        const date = document.getElementById("participantDate").value;
        const paymentMethod = document.getElementById("paymentMethod").value;

        if (!name || isNaN(investment) || isNaN(gain) || !date) {
            alert(translateText("Please fill all fields (Name, Investment, Gain, Date) with valid values."));
            return;
        }

        const newParticipant = {
            id: Date.now(), // Unique ID for finding participants in global array
            name: name,
            paymentValidated: false,
            investment: investment,
            gain: gain,
            date: date,
            paymentMethod: paymentMethod
        };

        participants.push(newParticipant);
        saveParticipants();
        renderParticipantsTable();

        document.getElementById("participantName").value = '';
        document.getElementById("participantInvestment").value = '';
        document.getElementById("participantGain").value = '';
    }

    function togglePaymentValidation(index) {
        if (index >= 0 && index < participants.length) {
            participants[index].paymentValidated = !participants[index].paymentValidated;
            saveParticipants();
            renderParticipantsTable();
        }
    }

    function deleteParticipant(index) {
        if (confirm(translateText("Are you sure you want to delete this participant?"))) {
            if (index >= 0 && index < participants.length) {
                // When deleting, also check if they are in the rotation queue
                const deletedParticipantId = participants[index].id;
                rotationMembersQueue = rotationMembersQueue.filter(p => p.id !== deletedParticipantId);

                participants.splice(index, 1);
                saveParticipants();
                renderParticipantsTable();
            }
        }
    }

    function nextDay() {
        alert(translateText("Action 'Next Day' executed. (Full functionality requires a backend)"));
        renderParticipantsTable();
    }

    function exportToExcel() {
        if (participants.length === 0) {
            alert(translateText("No data to export."));
            return;
        }

        const data = [
            [translateText("N¬∞"), translateText("Name"), translateText("Payment Validated"), translateText("Investment (‚Ç¨)"), translateText("Gain (‚Ç¨)"), translateText("Date"), translateText("Total (‚Ç¨)"), translateText("Payment Method")]
        ];
        participants.forEach((p, index) => {
            data.push([
                index + 1,
                p.name,
                p.paymentValidated ? translateText("Yes") : translateText("No"),
                p.investment,
                p.gain,
                p.date,
                p.investment + p.gain,
                p.paymentMethod
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, translateText("Participants"));
        XLSX.writeFile(wb, "D2B1_Participants_Historique.xlsx");
    }

    function resetData() {
        if (confirm(translateText("ATTENTION: This will erase ALL participant data. Are you sure?"))) {
            localStorage.removeItem('d2b1_participants');
            localStorage.removeItem('rotationMembersQueue');
            localStorage.removeItem('rolloverFund');

            participants = [];
            rotationMembersQueue = [];
            rolloverFund = 0;
            renderParticipantsTable();
            alert(translateText("All participant data has been reset."));
        }
    }

    function logout() { location.reload(); }

    function calculateGainOnEnter(event) {
        if (event.key === "Enter") {
            const investmentInput = document.getElementById("participantInvestment");
            const gainInput = document.getElementById("participantGain");

            const investment = parseFloat(investmentInput.value);

            if (!isNaN(investment) && investment > 0) {
                const calculatedGain = investment * 0.10; // Simple 10% gain for individual
                gainInput.value = calculatedGain.toFixed(2);
            } else {
                gainInput.value = '';
            }
        }
    }

    // --- Rotation Specific Functions ---
    function calculateRotationGain() {
        const totalInvestmentInput = document.getElementById("rotationTotalInvestment");
        const calculatedGainOutput = document.getElementById("calculatedRotationGain");
        const totalInvestment = parseFloat(totalInvestmentInput.value);

        if (isNaN(totalInvestment) || totalInvestment < 10) {
            calculatedGainOutput.value = '';
            alert(translateText("Must be a number 10 or more."));
            return;
        }

        // Apply the rotation logic as clarified: (N - N/3) + 0.3
        const gain = (totalInvestment - (totalInvestment / 3)) + 0.3;
        calculatedGainOutput.value = gain.toFixed(2);
    }

    function addParticipantInRotation() {
    const name = document.getElementById("participantName").value.trim();
    const investment = parseFloat(document.getElementById("participantInvestment").value);
    const date = document.getElementById("participantDate").value;
    const paymentMethod = document.getElementById("paymentMethod").value;

    if (!name || isNaN(investment) || !date) {
        alert(translateText("Please fill all fields (Name, Investment, Date) with valid values."));
        return;
    }

    const newParticipant = {
        id: Date.now(), // Assign a unique ID
        name: name,
        paymentValidated: false,
        investment: investment,
        gain: 0, // Initial gain is 0, will be updated if they win
        date: date,
        paymentMethod: paymentMethod
    };

    // Add participant to the global list and to the current rotation queue
    participants.push(newParticipant);
    rotationMembersQueue.push(newParticipant);

    saveParticipants(); // Save updated global list and rotation queue
    renderParticipantsTable(); // Re-render the main table

    let currentBatchSize = rotationMembersQueue.length;
    let isWinningConditionMet = false;

    // Condition for winning: First 10, then every 2
    if (participants.length <= 10 && currentBatchSize === 10) {
        isWinningConditionMet = true;
    } else if (participants.length > 10 && currentBatchSize === 2) {
        isWinningConditionMet = true;
    }

    if (isWinningConditionMet) {
        // Calculate total investment of the current batch for payout calculation
        const totalInvestmentForCurrentPayout = rotationMembersQueue.reduce((sum, p) => sum + p.investment, 0);

        // The effective total pool for this calculation includes the new investments AND the accumulated rollover.
        const currentTotalSystemFunds = totalInvestmentForCurrentPayout + rolloverFund;

        const winnerGain = (currentTotalSystemFunds - (currentTotalSystemFunds / 3)) + 0.3;

        // Select winner: Assuming the last person added to the current batch is the winner
        const winner = rotationMembersQueue[rotationMembersQueue.length - 1];

        // Update winner's gain in the global participants array
        const globalWinnerIndex = participants.findIndex(p => p.id === winner.id);
        if (globalWinnerIndex !== -1) {
            participants[globalWinnerIndex].gain = winnerGain;
        }

        // Calculate the amount that the system "keeps" from this `currentTotalSystemFunds`
        // (1/3 of the total, minus 10% fee on that 1/3)
        const amountRetainedBySystem = (currentTotalSystemFunds / 3) - (currentTotalSystemFunds / 3 * 0.10);

        // Update the `rolloverFund` for the next cycle:
        // It's the `currentTotalSystemFunds`
        // MINUS the `winnerGain`
        // PLUS the `amountRetainedBySystem` (which represents the 1/3 portion that is supposed to stay in the system).
        // This way, the rollover fund accounts for both money paid out and money explicitly kept.
        rolloverFund = currentTotalSystemFunds - winnerGain;
        rolloverFund += amountRetainedBySystem; // Add the portion that should fuel future payouts

        // Ensure rolloverFund doesn't go negative if there's a rounding issue or small amounts
        if (rolloverFund < 0) {
            rolloverFund = 0;
        }

        alert(`${translateText("Winner! Gain for this rotation:")} ${winnerGain.toFixed(2)} ${winner.paymentMethod} for ${winner.name}!`);

        // Reset the queue for the next batch of participants
        rotationMembersQueue = [];

        saveParticipants(); // Save updated participants (with winner's gain) and new rollover state
        renderParticipantsTable(); // Re-render to show winner's updated gain
    } else {
        alert(`${translateText("Participant added to rotation. Current count:")} ${currentBatchSize}${translateText(" for this winner cycle.")}`);
    }

    // Clear inputs after adding to rotation
    document.getElementById("participantName").value = '';
    document.getElementById("participantInvestment").value = '';
    document.getElementById("participantGain").value = '';
}
    }

    // --- Supervisor/Team Leader Functions (remain largely the same for history display) ---
    function ajouterSuperviseur() {
        const container = document.getElementById('superviseurs');
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <h4 data-translate="Supervisor Name">${translateText("Supervisor Name")}</h4>
            <input type="text" data-translate-placeholder="Supervisor Name" placeholder="${translateText('Supervisor Name')}" />
            <button onclick="ajouterTeamLeader(this)" class="btn-primary" data-translate="Supervisor +1">${translateText("Supervisor +1")}</button>
            <div class="teamleaders"></div>
            <div style="margin-top: 20px;">
                <h4 data-translate="Participant History">${translateText("Participant History")}</h4>
                <table>
                    <thead>
                        <tr>
                            <th data-translate="N¬∞">${translateText("N¬∞")}</th>
                            <th data-translate="Name">${translateText("Name")}</th>
                            <th data-translate="Paiement Valid√©">${translateText("Paiement Valid√©")}</th>
                            <th data-translate="Investment (‚Ç¨)">${translateText("Investment (‚Ç¨)")}</th>
                            <th data-translate="Gain (‚Ç¨)">${translateText("Gain (‚Ç¨)")}</th>
                            <th data-translate="Date">${translateText("Date")}</th>
                            <th data-translate="Total (‚Ç¨)">${translateText("Total (‚Ç¨)")}</th>
                            <th data-translate="Payment Method">${translateText("Payment Method")}</th>
                        </tr>
                    </thead>
                    <tbody class="supervisor-history-body">
                        </tbody>
                </table>
            </div>
            <button onclick="demanderAction('reset')" class="btn-danger" data-translate="Request Reset">${translateText("Request Reset")}</button>
            <button onclick="demanderAction('logout')" class="btn-danger" data-translate="Request Logout">${translateText("Request Logout")}</button>
        `;
        container.appendChild(div);
        renderSupervisorHistory(div.querySelector('.supervisor-history-body'));
    }

    function ajouterTeamLeader(btn) {
        const container = btn.nextElementSibling;
        const div = document.createElement('div');
        div.className = 'card team-leader-card';
        div.innerHTML = `
            <input type="text" data-translate-placeholder="Team Leader Name" placeholder="${translateText('Team Leader Name')}" />
            <input type="text" data-translate-placeholder="Participant Name (for TL)" placeholder="${translateText('Participant Name (for TL)')}" />
            <button class="btn-primary" data-translate="Add">${translateText("Add")}</button>
            <button class="btn-secondary" data-translate="Validate Payment">${translateText("Validate Payment")}</button>
            <button onclick="nextDayTL()" class="btn-secondary" data-translate="Next Day">${translateText("Next Day")}</button>
            <button onclick="exportToExcelTL()" class="btn-primary" data-translate="Export">${translateText("Export")}</button>
            <div style="margin-top: 20px;">
                <h4 data-translate="Participant History">${translateText("Participant History")}</h4>
                <table>
                    <thead>
                        <tr>
                            <th data-translate="N¬∞">${translateText("N¬∞")}</th>
                            <th data-translate="Name">${translateText("Name")}</th>
                            <th data-translate="Paiement Valid√©">${translateText("Paiement Valid√©")}</th>
                            <th data-translate="Investment (‚Ç¨)">${translateText("Investment (‚Ç¨)")}</th>
                            <th data-translate="Gain (‚Ç¨)">${translateText("Gain (‚Ç¨)")}</th>
                            <th data-translate="Date">${translateText("Date")}</th>
                            <th data-translate="Total (‚Ç¨)">${translateText("Total (‚Ç¨)")}</th>
                            <th data-translate="Payment Method">${translateText("Payment Method")}</th>
                        </tr>
                    </thead>
                    <tbody class="teamleader-history-body">
                        </tbody>
                </table>
            </div>
        `;
        container.appendChild(div);
        renderTeamLeaderHistory(div.querySelector('.teamleader-history-body'));
    }

    function renderSupervisorHistory(tableBodyElement) {
        if (!tableBodyElement) return;

        tableBodyElement.innerHTML = '';
        if (participants.length === 0) {
            tableBodyElement.innerHTML = `<tr><td colspan="8">${translateText("No participant recorded.")}</td></tr>`;
            return;
        }

        participants.forEach((p, index) => {
            const row = tableBodyElement.insertRow();
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${p.name}</td>
                <td class="${p.paymentValidated ? 'payment-validated' : 'payment-pending'}">
                    ${p.paymentValidated ? translateText('Yes') : translateText('No')}
                </td>
                <td>${p.investment.toFixed(2)}</td>
                <td>${p.gain.toFixed(2)}</td>
                <td>${p.date}</td>
                <td>${(p.investment + p.gain).toFixed(2)}</td>
                <td>${p.paymentMethod}</td>
            `;
        });
    }

    function renderTeamLeaderHistory(tableBodyElement) {
        renderSupervisorHistory(tableBodyElement);
    }

    function nextDayTL() {
        nextDay();
    }

    function exportToExcelTL() {
        exportToExcel();
    }

    function demanderAction(type) {
        const msg = type === 'reset' ? translateText('Request for reset sent to administrator') : translateText('Request for logout sent to administrator');
        alert(msg);
    }

    // --- Password Strength Check ---
    function checkPasswordStrength() {
        const password = document.getElementById("adminPass").value;
        const messageElement = document.getElementById("passwordStrengthMessage");

        if (password === SECURE_ADMIN_PASSWORD) {
            messageElement.textContent = translateText("Password correct.");
            messageElement.style.color = "green";
        } else if (isValidAdminPassword(password)) {
            messageElement.textContent = translateText("Strong password (but incorrect).");
            messageElement.style.color = "orange";
        } else {
            messageElement.textContent = translateText("Password must contain at least 8 characters, including one uppercase, one lowercase, one number, and one special character.");
            messageElement.style.color = "red";
        }
    }
</script>

<div class="card" id="authCard">
    <div class="language-selector">
        <label for="languageSelector">Language:</label>
        <select id="languageSelector">
            <option value="en">English</option>
            <option value="fr">Fran√ßais</option>
        </select>
    </div>
    <h1 data-translate="Secure Admin Space">Secure Admin Space</h1>
    <input type="password" id="adminPass" data-translate-placeholder="Admin Password" placeholder="Admin Password" onkeyup="checkPasswordStrength()"/>
    <p id="passwordStrengthMessage" style="font-size:0.8em; color: gray;"></p>
    <div class="button-group">
        <button onclick="toggleVisibility('adminPass')" class="btn-secondary" data-translate="Show/Hide">üëÅÔ∏è Show/Hide</button>
        <button onclick="checkAdminStep1()" class="btn-primary" data-translate="Login">üîê Login</button>
    </div>
    <div id="forgotSection" onclick="alert(translateText('Please contact administrator to reset your password.'))" data-translate="Forgot password?">Forgot password?</div>
</div>

<div class="card" id="codeCard" style="display:none;">
    <p data-translate="OTP code sent to your email.">üì§ OTP code sent to your email.</p>
    <input type="password" id="code2FA" data-translate-placeholder="Enter OTP code" placeholder="Enter OTP code" />
    <div class="button-group">
        <button onclick="toggleVisibility('code2FA')" class="btn-secondary" data-translate="Show/Hide">üëÅÔ∏è Show/Hide</button>
        <button onclick="checkAdminStep2()" class="btn-primary" data-translate="Verify">‚úÖ Verify</button>
    </div>
</div>

<div class="card" id="mainCard" style="display:none;">
    <h3 data-translate="D2B1 - Participant Management">D2B1 - Participant Management</h3>

    <input type="text" id="participantName" data-translate-placeholder="Participant Name" placeholder="Participant Name" />
    <input type="number" id="participantInvestment" data-translate-placeholder="Investment (‚Ç¨)" placeholder="Investment (‚Ç¨)" step="0.01" />

    <label for="paymentMethod" data-translate="Payment Method">Payment Method:</label>
    <select id="paymentMethod">
        <option value="USD" selected>USD - US Dollar</option>
        <option value="HTG">HTG - Haitian Gourde</option>
        <option value="EUR">EUR - Euro</option>
        <option value="CAD">CAD - Canadian Dollar</option>
        <option value="GBP">GBP - British Pound</option>
    </select>
    
    <input type="number" id="participantGain" data-translate-placeholder="Gain (‚Ç¨)" placeholder="Gain (‚Ç¨)" step="0.01" readonly />
    <input type="date" id="participantDate" />

    <button onclick="addParticipant()" class="btn-primary" data-translate="Add Participant (Normal)">‚ûï Add Participant (Normal)</button>
    <button onclick="addParticipantInRotation()" id="addParticipantInRotationBtn" data-translate="Add Participant in Rotation">üîÑ Add Participant in Rotation</button>

    <div class="rotation-calculator-section">
        <h4 data-translate="Rotation Gain Calculator">Rotation Gain Calculator</h4>
        <input type="number" id="rotationTotalInvestment" data-translate-placeholder="Total Investment (for 10 participants)" placeholder="Total Investment (for 10 participants)" step="0.01" />
        <input type="number" id="calculatedRotationGain" data-translate-placeholder="Calculated Gain (for Winner)" placeholder="Calculated Gain (for Winner)" step="0.01" readonly />
        <button onclick="calculateRotationGain()" class="btn-primary" data-translate="Calculate Gain">üßÆ Calculate Gain</button>
    </div>

    <button onclick="nextDay()" class="btn-secondary" data-translate="Next Day">üîÅ Next Day</button>
    <button onclick="exportToExcel()" class="btn-primary" data-translate="Export History">üì§ Export History</button>
    <button onclick="resetData()" class="btn-danger" data-translate="Reset Data">üóëÔ∏è Reset Data</button>
    <button onclick="logout()" class="btn-danger" data-translate="Logout">üö™ Logout</button>

    <div id="stats" style="margin-top:20px;"></div>

    <div id="historyTable" style="margin-top:20px;">
        <h4 data-translate="Participant History">Participant History</h4>
        <table>
            <thead>
                <tr>
                    <th data-translate="N¬∞">N¬∞</th>
                    <th data-translate="Name">Name</th>
                    <th data-translate="Paiement Valid√©">Paiement Valid√©</th>
                    <th data-translate="Investment (‚Ç¨)">Investment (‚Ç¨)</th>
                    <th data-translate="Gain (‚Ç¨)">Gain (‚Ç¨)</th>
                    <th data-translate="Date">Date</th>
                    <th data-translate="Total (‚Ç¨)">Total (‚Ç¨)</th>
                    <th data-translate="Payment Method">Payment Method</th>
                    <th data-translate="Actions">Actions</th>
                </tr>
            </thead>
            <tbody id="participantsTableBody">
                </tbody>
        </table>
    </div>

    <div id="participantsList" style="margin-top:20px;"></div>
</div>

<div class="card" id="superviseurContainer" style="display:none;">
    <h3 data-translate="Add Supervisor">Add Supervisor</h3>
    <button class="btn-primary" onclick="ajouterSuperviseur()" data-translate="Supervisor +1">üë®‚Äçüíº Supervisor +1</button>
    <div id="superviseurs"></div>
</div>

</body>
</html>
