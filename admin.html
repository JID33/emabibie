<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-translate="D2B1 - Secure Administration">D2B1 - Secure Administration</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #e0eafc, #cfdef3);
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .card {
            background: white;
            padding: 30px;
            margin: 20px auto;
            max-width: 650px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            box-sizing: border-box;
            text-align: center;
        }
        h2, h3, h4 {
            color: #333;
            margin-bottom: 20px;
        }
        input[type="password"],
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        select {
            width: calc(100% - 20px);
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-primary {
            background-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .password-strength {
            margin-top: 5px;
            font-size: 0.9em;
        }
        .strength-weak { color: red; }
        .strength-medium { color: orange; }
        .strength-strong { color: green; }
        .strength-very-strong { color: darkgreen; } /* Added for very strong */
        .alert {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: left;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            font-size: 14px;
        }
        th {
            background-color: #f2f2f2;
            color: #555;
            text-transform: uppercase;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .language-selector {
            margin-bottom: 20px;
        }
        .action-buttons button {
            margin: 2px;
            padding: 8px 12px;
            font-size: 13px;
        }
    </style>
</head>
<body>

    <div class="card" id="authCard">
        <h2 data-translate="Espace Admin S√©curis√©">Espace Admin S√©curis√©</h2>
        <input type="password" id="adminPass" placeholder="Mot de passe admin" onkeyup="checkPasswordStrength(this.value)">
        <div id="passwordStrength" class="password-strength"></div>
        <button onclick="toggleVisibility('adminPass')" data-translate="Show/Hide">üëÅÔ∏è Afficher/Cacher</button>
        <button onclick="checkAdminStep1()" data-translate="Login">üîê Connexion</button>
        <p><a href="#" onclick="alert('Please contact support to reset your password.');" data-translate="Forgot password?">Mot de passe oubli√© ?</a></p>
    </div>

    <div class="card" id="codeCard" style="display:none;">
        <h2 data-translate="Authentication Code">Code d'Authentification</h2>
        <input type="text" id="adminCode" placeholder="Enter code">
        <button onclick="checkAdminStep2()" data-translate="Verify Code">‚úîÔ∏è V√©rifier Code</button>
    </div>

    <div class="card" id="adminPanel" style="display:none;">
        <div class="language-selector">
            <label for="languageSelect" data-translate="Select Language:">Select Language:</label>
            <select id="languageSelect" onchange="setLanguage(this.value)">
                <option value="fr">Fran√ßais</option>
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
            </select>
        </div>
        <h2 data-translate="D2B1 - Administration">D2B1 - Administration</h2>

        <div class="input-group">
            <input type="text" id="participantName" placeholder="Nom du participant" data-translate-placeholder="Participant Name">
            <input type="number" id="participantInvestment" placeholder="Montant d'investissement" data-translate-placeholder="Investment Amount">
            <input type="date" id="participantDate" data-translate-placeholder="Date">
            <select id="paymentMethod">
                <option value="cash" data-translate="Cash">Cash</option>
                <option value="card" data-translate="Card">Card</option>
            </select>
            <button onclick="addParticipantInRotation()" class="btn-primary" data-translate="Add Participant to Rotation">üîÑ Add Participant to Rotation</button>
        </div>

        <button onclick="togglePaymentValidation()" class="btn-success" data-translate="Validate Payment">‚úÖ Validate Payment</button>
        <button onclick="nextDay()" class="btn-secondary" data-translate="Next Day">‚è© Next Day</button>
        <button onclick="exportToExcel()" class="btn-info" data-translate="Export History">üìä Export History</button>
        <button onclick="resetData()" class="btn-danger" data-translate="Reset Data">üóëÔ∏è Reset Data</button>
        <button onclick="logout()" class="btn-danger" data-translate="Logout">üö™ Logout</button>

        <div id="stats" style="margin-top:20px;"></div>

        <div id="historyTable" style="margin-top:20px;">
            <h4 data-translate="Participant History">Participant History</h4>
            <table>
                <thead>
                    <tr>
                        <th data-translate="N¬∞">N¬∞</th>
                        <th data-translate="Name">Name</th>
                        <th data-translate="Paiement Valid√©">Paiement Valid√©</th>
                        <th data-translate="Investment (‚Ç¨)">Investment (‚Ç¨)</th>
                        <th data-translate="Gain (‚Ç¨)">Gain (‚Ç¨)</th>
                        <th data-translate="Date">Date</th>
                        <th data-translate="Total (‚Ç¨)">Total (‚Ç¨)</th>
                        <th data-translate="Payment Method">Payment Method</th>
                        <th data-translate="Actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="participantsTableBody">
                </tbody>
            </table>
        </div>

        <div id="participantsList" style="margin-top:20px;"></div>
    </div>

    <div class="card" id="superviseurContainer" style="display:none;">
        <h3 data-translate="Add Supervisor">Add Supervisor</h3>
        <button class="btn-primary" onclick="ajouterSuperviseur()" data-translate="Supervisor +1">üë®‚Äçüíº Supervisor +1</button>
        <div id="superviseurList"></div>
    </div>

    <div class="card" id="teamLeaderContainer" style="display:none;">
        <h3 data-translate="Add Team Leader">Add Team Leader</h3>
        <input type="text" id="teamLeaderName" placeholder="Nom du Team Leader" data-translate-placeholder="Team Leader Name">
        <button class="btn-primary" onclick="ajouterTeamLeader()" data-translate="Team Leader +1">üßë‚Äçüíª Team Leader +1</button>
        <button onclick="nextDayTL()" class="btn-secondary" data-translate="Next Day (TL)">‚è© Next Day (TL)</button>
        <button onclick="exportToExcelTL()" class="btn-info" data-translate="Export History (TL)">üìä Export History (TL)</button>
        <div id="teamLeaderList"></div>
    </div>

<script>
    // --- Global Variables and Constants ---
    const SECURE_ADMIN_PASSWORD = "D2B1@dmin2025"; // !!! CHANGE THIS TO A SECURE PASSWORD !!!
    const OTP_LENGTH = 6;
    let currentOTP = '';
    let participants = [];
    let rotationMembersQueue = []; // Temporarily holds participants for the current 10-person or 2-person batch
    let rolloverFund = 0; // Amount that carries over from previous rotation

    let supervisors = [];
    let teamLeaders = [];
    let currentLanguage = localStorage.getItem('language') || 'fr'; // Default to French

    // EmailJS configuration (replace with your actual IDs)
    emailjs.init("YOUR_EMAILJS_PUBLIC_KEY"); // Replace with your EmailJS Public Key
    const EMAILJS_SERVICE_ID = "YOUR_EMAILJS_SERVICE_ID"; // Replace with your EmailJS Service ID
    const EMAILJS_TEMPLATE_ID = "YOUR_EMAILJS_TEMPLATE_ID"; // Replace with your EmailJS Template ID (for OTP)
    const EMAILJS_CONTACT_TEMPLATE_ID = "template_tq202es"; // From image_8f3905.png

    // --- Translations ---
    const translations = {
        fr: {
            "D2B1 - Secure Administration": "D2B1 - Administration S√©curis√©e",
            "Espace Admin S√©curis√©": "Espace Admin S√©curis√©",
            "Mot de passe admin": "Mot de passe admin",
            "Show/Hide": "Afficher/Cacher",
            "Login": "Connexion",
            "Forgot password?": "Mot de passe oubli√© ?",
            "Authentication Code": "Code d'Authentification",
            "Enter code": "Entrer le code",
            "Verify Code": "V√©rifier Code",
            "D2B1 - Administration": "D2B1 - Administration",
            "Select Language:": "S√©lectionner la Langue :",
            "Participant Name": "Nom du participant",
            "Investment Amount": "Montant d'investissement",
            "Date": "Date",
            "Cash": "Cash",
            "Card": "Carte",
            "Add Participant to Rotation": "Ajouter Participant √† la Rotation",
            "Validate Payment": "Valider Paiement",
            "Next Day": "Jour Suivant",
            "Export History": "Exporter Historique",
            "Reset Data": "R√©initialiser Donn√©es",
            "Logout": "D√©connexion",
            "Participant History": "Historique des Participants",
            "N¬∞": "N¬∞",
            "Name": "Nom",
            "Paiement Valid√©": "Paiement Valid√©",
            "Investment (‚Ç¨)": "Investissement (‚Ç¨)",
            "Gain (‚Ç¨)": "Gain (‚Ç¨)",
            "Total (‚Ç¨)": "Total (‚Ç¨)",
            "Payment Method": "M√©thode de Paiement",
            "Actions": "Actions",
            "Edit": "Modifier",
            "Delete": "Supprimer",
            "Add Supervisor": "Ajouter Superviseur",
            "Supervisor +1": "Superviseur +1",
            "Add Team Leader": "Ajouter Chef d'√âquipe",
            "Team Leader Name": "Nom du Chef d'√âquipe",
            "Team Leader +1": "Chef d'√âquipe +1",
            "Next Day (TL)": "Jour Suivant (CE)",
            "Export History (TL)": "Exporter Historique (CE)",
            "Participant added successfully!": "Participant ajout√© avec succ√®s !",
            "Please fill all fields (Name, Investment, Date) with valid values.": "Veuillez remplir tous les champs (Nom, Investissement, Date) avec des valeurs valides.",
            "Winner! Gain for this rotation:": "Gagnant ! Gain pour cette rotation :",
            " for ": " pour ",
            "Participant added to rotation. Current count:": "Participant ajout√© √† la rotation. Compte actuel :",
            " for this winner cycle.": " pour ce cycle de gagnant.",
            "Payment validated successfully!": "Paiement valid√© avec succ√®s !",
            "All fields must be filled for new participant.": "Tous les champs doivent √™tre remplis pour un nouveau participant.",
            "Data reset successfully!": "Donn√©es r√©initialis√©es avec succ√®s !",
            "Logged out successfully.": "D√©connect√© avec succ√®s.",
            "Please enter a valid OTP.": "Veuillez entrer un code OTP valide.",
            "OTP sent successfully! Check your email.": "OTP envoy√© avec succ√®s ! V√©rifiez votre e-mail.",
            "Failed to send OTP. Please try again.": "√âchec de l'envoi de l'OTP. Veuillez r√©essayer.",
            "Incorrect OTP. Please try again.": "OTP incorrect. Veuillez r√©essayer.",
            "Login successful!": "Connexion r√©ussie !",
            "Invalid admin password.": "Mot de passe admin invalide.",
            "Password is too weak.": "Le mot de passe est trop faible.",
            "Password strength: Weak": "Force du mot de passe : Faible",
            "Password strength: Medium": "Force du mot de passe : Moyenne",
            "Password strength: Strong": "Force du mot de passe : Forte",
            "Password strength: Very Strong": "Force du mot de passe : Tr√®s Forte",
            "Amount due for validation: ": "Montant d√ª pour validation : ",
            "Are you sure you want to delete ": "Voulez-vous vraiment supprimer ",
            " and all its data?": " et toutes ses donn√©es ?",
            "Supervisor added successfully!": "Superviseur ajout√© avec succ√®s !",
            "Team Leader added successfully!": "Chef d'√©quipe ajout√© avec succ√®s !",
            "Action request sent.": "Demande d'action envoy√©e.",
            "Failed to send action request.": "√âchec de l'envoi de la demande d'action.",
            "Please select a Team Leader.": "Veuillez s√©lectionner un Chef d'√âquipe.",
            "No Team Leader selected.": "Aucun Chef d'√âquipe s√©lectionn√©.",
            "Enter a name for the Team Leader.": "Entrez un nom pour le Chef d'√âquipe.",
            "No supervisor selected.": "Aucun superviseur s√©lectionn√©.",
            "This will reset all data. Are you sure?": "Ceci r√©initialisera toutes les donn√©es. √ätes-vous s√ªr ?",
            "Cannot validate payment, participant not found.": "Impossible de valider le paiement, participant non trouv√©.",
            "Gain calculated successfully!": "Gain calcul√© avec succ√®s !",
            "Total Gain (‚Ç¨)": "Gain Total (‚Ç¨)",
            "Total Investment (‚Ç¨)": "Investissement Total (‚Ç¨)",
            "Total Participants": "Nombre Total de Participants",
            "Current Rollover Fund (‚Ç¨)": "Fonds de Roulement Actuel (‚Ç¨)"
        },
        en: {
            "D2B1 - Secure Administration": "D2B1 - Secure Administration",
            "Espace Admin S√©curis√©": "Secure Admin Space",
            "Mot de passe admin": "Admin password",
            "Show/Hide": "Show/Hide",
            "Login": "Login",
            "Forgot password?": "Forgot password?",
            "Authentication Code": "Authentication Code",
            "Enter code": "Enter code",
            "Verify Code": "Verify Code",
            "D2B1 - Administration": "D2B1 - Administration",
            "Select Language:": "Select Language:",
            "Participant Name": "Participant Name",
            "Investment Amount": "Investment Amount",
            "Date": "Date",
            "Cash": "Cash",
            "Card": "Card",
            "Add Participant to Rotation": "Add Participant to Rotation",
            "Validate Payment": "Validate Payment",
            "Next Day": "Next Day",
            "Export History": "Export History",
            "Reset Data": "Reset Data",
            "Logout": "Logout",
            "Participant History": "Participant History",
            "N¬∞": "N¬∞",
            "Name": "Name",
            "Paiement Valid√©": "Payment Validated",
            "Investment (‚Ç¨)": "Investment (‚Ç¨)",
            "Gain (‚Ç¨)": "Gain (‚Ç¨)",
            "Total (‚Ç¨)": "Total (‚Ç¨)",
            "Payment Method": "Payment Method",
            "Actions": "Actions",
            "Edit": "Edit",
            "Delete": "Delete",
            "Add Supervisor": "Add Supervisor",
            "Supervisor +1": "Supervisor +1",
            "Add Team Leader": "Add Team Leader",
            "Team Leader Name": "Team Leader Name",
            "Team Leader +1": "Team Leader +1",
            "Next Day (TL)": "Next Day (TL)",
            "Export History (TL)": "Export History (TL)",
            "Participant added successfully!": "Participant added successfully!",
            "Please fill all fields (Name, Investment, Date) with valid values.": "Please fill all fields (Name, Investment, Date) with valid values.",
            "Winner! Gain for this rotation:": "Winner! Gain for this rotation:",
            " for ": " for ",
            "Participant added to rotation. Current count:": "Participant added to rotation. Current count:",
            " for this winner cycle.": " for this winner cycle.",
            "Payment validated successfully!": "Payment validated successfully!",
            "All fields must be filled for new participant.": "All fields must be filled for new participant.",
            "Data reset successfully!": "Data reset successfully!",
            "Logged out successfully.": "Logged out successfully.",
            "Please enter a valid OTP.": "Please enter a valid OTP.",
            "OTP sent successfully! Check your email.": "OTP sent successfully! Check your email.",
            "Failed to send OTP. Please try again.": "Failed to send OTP. Please try again.",
            "Incorrect OTP. Please try again.": "Incorrect OTP. Please try again.",
            "Login successful!": "Login successful!",
            "Invalid admin password.": "Invalid admin password.",
            "Password is too weak.": "Password is too weak.",
            "Password strength: Weak": "Password strength: Weak",
            "Password strength: Medium": "Password strength: Medium",
            "Password strength: Strong": "Password strength: Strong",
            "Password strength: Very Strong": "Password strength: Very Strong",
            "Amount due for validation: ": "Amount due for validation: ",
            "Are you sure you want to delete ": "Are you sure you want to delete ",
            " and all its data?": " and all its data?",
            "Supervisor added successfully!": "Supervisor added successfully!",
            "Team Leader added successfully!": "Team Leader added successfully!",
            "Action request sent.": "Action request sent.",
            "Failed to send action request.": "Failed to send action request.",
            "Please select a Team Leader.": "Please select a Team Leader.",
            "No Team Leader selected.": "No Team Leader selected.",
            "Enter a name for the Team Leader.": "Enter a name for the Team Leader.",
            "No supervisor selected.": "No supervisor selected.",
            "This will reset all data. Are you sure?": "This will reset all data. Are you sure?",
            "Cannot validate payment, participant not found.": "Cannot validate payment, participant not found.",
            "Gain calculated successfully!": "Gain calculated successfully!",
            "Total Gain (‚Ç¨)": "Total Gain (‚Ç¨)",
            "Total Investment (‚Ç¨)": "Total Investment (‚Ç¨)",
            "Total Participants": "Total Participants",
            "Current Rollover Fund (‚Ç¨)": "Current Rollover Fund (‚Ç¨)"
        },
        es: {
            "D2B1 - Secure Administration": "D2B1 - Administraci√≥n Segura",
            "Espace Admin S√©curis√©": "Espacio de Administrador Seguro",
            "Mot de passe admin": "Contrase√±a de administrador",
            "Show/Hide": "Mostrar/Ocultar",
            "Login": "Iniciar Sesi√≥n",
            "Forgot password?": "¬øOlvid√≥ su contrase√±a?",
            "Authentication Code": "C√≥digo de Autenticaci√≥n",
            "Enter code": "Introducir c√≥digo",
            "Verify Code": "Verificar C√≥digo",
            "D2B1 - Administration": "D2B1 - Administraci√≥n",
            "Select Language:": "Seleccionar Idioma:",
            "Participant Name": "Nombre del Participante",
            "Investment Amount": "Monto de Inversi√≥n",
            "Date": "Fecha",
            "Cash": "Efectivo",
            "Card": "Tarjeta",
            "Add Participant to Rotation": "A√±adir Participante a la Rotaci√≥n",
            "Validate Payment": "Validar Pago",
            "Next Day": "D√≠a Siguiente",
            "Export History": "Exportar Historial",
            "Reset Data": "Restablecer Datos",
            "Logout": "Cerrar Sesi√≥n",
            "Participant History": "Historial de Participantes",
            "N¬∞": "N¬∫",
            "Name": "Nombre",
            "Paiement Valid√©": "Pago Validado",
            "Investment (‚Ç¨)": "Inversi√≥n (‚Ç¨)",
            "Gain (‚Ç¨)": "Ganancia (‚Ç¨)",
            "Total (‚Ç¨)": "Total (‚Ç¨)",
            "Payment Method": "M√©todo de Pago",
            "Actions": "Acciones",
            "Edit": "Editar",
            "Delete": "Eliminar",
            "Add Supervisor": "A√±adir Supervisor",
            "Supervisor +1": "Supervisor +1",
            "Add Team Leader": "A√±adir L√≠der de Equipo",
            "Team Leader Name": "Nombre del L√≠der de Equipo",
            "Team Leader +1": "L√≠der de Equipo +1",
            "Next Day (TL)": "D√≠a Siguiente (LE)",
            "Export History (TL)": "Exportar Historial (LE)",
            "Participant added successfully!": "¬°Participante a√±adido con √©xito!",
            "Please fill all fields (Name, Investment, Fecha) with valid values.": "Por favor, rellene todos los campos (Nombre, Inversi√≥n, Fecha) con valores v√°lidos.",
            "Winner! Gain for this rotation:": "¬°Ganador! Ganancia para esta rotaci√≥n:",
            " for ": " para ",
            "Participant added to rotation. Current count:": "Participante a√±adido a la rotaci√≥n. Recuento actual:",
            " for this winner cycle.": " para este ciclo de ganador.",
            "Payment validated successfully!": "¬°Pago validado con √©xito!",
            "All fields must be filled for new participant.": "Todos los campos deben ser llenados para un nuevo participante.",
            "Data reset successfully!": "¬°Datos restablecidos con √©xito!",
            "Logged out successfully.": "Sesi√≥n cerrada con √©xito.",
            "Please enter a valid OTP.": "Por favor, introduzca un OTP v√°lido.",
            "OTP sent successfully! Check your email.": "¬°OTP enviado con √©xito! Revise su correo electr√≥nico.",
            "Failed to send OTP. Please try again.": "Error al enviar el OTP. Por favor, int√©ntelo de nuevo.",
            "Incorrect OTP. Please try again.": "OTP incorrecto. Por favor, int√©ntelo de nuevo.",
            "Login successful!": "¬°Inicio de sesi√≥n exitoso!",
            "Invalid admin password.": "Contrase√±a de administrador inv√°lida.",
            "Password is too weak.": "La contrase√±a es demasiado d√©bil.",
            "Password strength: Weak": "Fuerza de la contrase√±a: D√©bil",
            "Password strength: Medium": "Fuerza de la contrase√±a: Media",
            "Password strength: Strong": "Fuerza de la contrase√±a: Fuerte",
            "Password strength: Very Strong": "Fuerza de la contrase√±a: Muy Fuerte",
            "Amount due for validation: ": "Cantidad a validar: ",
            "Are you sure you want to delete ": "¬øEst√° seguro de que desea eliminar ",
            " and all its data?": " y todos sus datos?",
            "Supervisor added successfully!": "¬°Supervisor a√±adido con √©xito!",
            "Team Leader added successfully!": "¬°L√≠der de equipo a√±adido con √©xito!",
            "Action request sent.": "Solicitud de acci√≥n enviada.",
            "Failed to send action request.": "Error al enviar la solicitud de acci√≥n.",
            "Please select a Team Leader.": "Por favor, seleccione un L√≠der de Equipo.",
            "No Team Leader selected.": "Ning√∫n L√≠der de Equipo seleccionado.",
            "Enter a name for the Team Leader.": "Ingrese un nombre para el L√≠der de Equipo.",
            "No supervisor selected.": "Ning√∫n supervisor seleccionado.",
            "This will reset all data. Are you sure?": "Esto restablecer√° todos los datos. ¬øEst√° seguro?",
            "Cannot validate payment, participant not found.": "No se puede validar el pago, participante no encontrado.",
            "Gain calculated successfully!": "¬°Ganancia calculada con √©xito!",
            "Total Gain (‚Ç¨)": "Ganancia Total (‚Ç¨)",
            "Total Investment (‚Ç¨)": "Inversi√≥n Total (‚Ç¨)",
            "Total Participants": "N√∫mero Total de Participantes",
            "Current Rollover Fund (‚Ç¨)": "Fondo de Rotaci√≥n Actual (‚Ç¨)"
        }
    };

    function translateText(key) {
        return translations[currentLanguage][key] || key;
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        applyTranslations();
    }

    function applyTranslations() {
        document.querySelectorAll('[data-translate]').forEach(element => {
            element.textContent = translateText(element.getAttribute('data-translate'));
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
            element.placeholder = translateText(element.getAttribute('data-translate-placeholder'));
        });
        // Removed recursive calls to renderParticipantsTable() and renderStats() from here.
        // These functions should manage their own rendering and translation of dynamic content.
    }

    // --- Login and Authentication Functions ---
    function checkPasswordStrength(password) {
        const strengthDisplay = document.getElementById('passwordStrength');
        let strength = 0;
        if (password.length >= 8) strength++; // Stronger passwords start at 8 characters
        if (password.length >= 12) strength++; // Even stronger at 12
        if (/[A-Z]/.test(password)) strength++; // Uppercase letters
        if (/[0-9]/.test(password)) strength++; // Numbers
        if (/[^A-Za-z0-9]/.test(password)) strength++; // Special characters

        let strengthText = translateText("Password strength: Weak");
        let strengthClass = "strength-weak";

        if (strength >= 5) {
            strengthText = translateText("Password strength: Very Strong");
            strengthClass = "strength-very-strong";
        } else if (strength >= 4) {
            strengthText = translateText("Password strength: Strong");
            strengthClass = "strength-strong";
        } else if (strength >= 3) {
            strengthText = translateText("Password strength: Medium");
            strengthClass = "strength-medium";
        }

        strengthDisplay.textContent = strengthText;
        strengthDisplay.className = 'password-strength ' + strengthClass;
    }

    function toggleVisibility(id) {
        const input = document.getElementById(id);
        if (input.type === "password") {
            input.type = "text";
        } else {
            input.type = "password";
        }
    }

    function generateOTP() {
        let otp = '';
        for (let i = 0; i < OTP_LENGTH; i++) {
            otp += Math.floor(Math.random() * 10);
        }
        return otp;
    }

    function sendOTP(email) {
        currentOTP = generateOTP(); // Store the generated OTP
        const templateParams = {
            to_email: email,
            otp_code: currentOTP
        };

        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
            .then(function(response) {
                alert(translateText('OTP sent successfully! Check your email.'));
            }, function(error) {
                console.error('Failed to send OTP:', error);
                alert(translateText('Failed to send OTP. Please try again.'));
            });
    }

    function checkAdminStep1() {
        const adminPass = document.getElementById('adminPass').value;
        if (adminPass === SECURE_ADMIN_PASSWORD) {
            // Assuming admin's email is hardcoded or fetched from somewhere
            // IMPORTANT: Replace "D2B1.Admin@gmail.com" with the actual admin email where OTP should be sent
            sendOTP("D2B1.Admin@gmail.com"); 
            document.getElementById('authCard').style.display = 'none';
            document.getElementById('codeCard').style.display = 'block';
        } else {
            alert(translateText('Invalid admin password.'));
        }
    }

    function checkAdminStep2() {
        const enteredOTP = document.getElementById('adminCode').value;
        if (enteredOTP === currentOTP) {
            localStorage.setItem('loggedIn', 'true');
            document.getElementById('codeCard').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            alert(translateText('Login successful!'));
            loadParticipants();
            renderParticipantsTable(); // Now renderTable will call renderStats
            applyTranslations(); // Apply translations to static elements once after login
        } else {
            alert(translateText('Incorrect OTP. Please try again.'));
        }
    }

    function logout() {
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('participants');
        localStorage.removeItem('rotationMembersQueue');
        localStorage.removeItem('rolloverFund');
        localStorage.removeItem('supervisors');
        localStorage.removeItem('teamLeaders');
        participants = [];
        rotationMembersQueue = [];
        rolloverFund = 0;
        supervisors = [];
        teamLeaders = [];
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('authCard').style.display = 'block';
        document.getElementById('adminPass').value = ''; // Clear password field
        document.getElementById('adminCode').value = ''; // Clear OTP field
        alert(translateText('Logged out successfully.'));
        renderParticipantsTable(); // Clear table display
    }

    // --- Data Storage and Management ---
    function saveParticipants() {
        localStorage.setItem('participants', JSON.stringify(participants));
        localStorage.setItem('rotationMembersQueue', JSON.stringify(rotationMembersQueue));
        localStorage.setItem('rolloverFund', rolloverFund.toString());
        localStorage.setItem('supervisors', JSON.stringify(supervisors));
        localStorage.setItem('teamLeaders', JSON.stringify(teamLeaders));
    }

    function loadParticipants() {
        participants = JSON.parse(localStorage.getItem('participants') || '[]');
        rotationMembersQueue = JSON.parse(localStorage.getItem('rotationMembersQueue') || '[]');
        rolloverFund = parseFloat(localStorage.getItem('rolloverFund') || '0');
        supervisors = JSON.parse(localStorage.getItem('supervisors') || '[]');
        teamLeaders = JSON.parse(localStorage.getItem('teamLeaders') || '[]');
    }

    // --- Participant & Rotation Management ---
    function addParticipantInRotation() {
        const name = document.getElementById("participantName").value.trim();
        const investment = parseFloat(document.getElementById("participantInvestment").value);
        const date = document.getElementById("participantDate").value;
        const paymentMethod = document.getElementById("paymentMethod").value;

        if (!name || isNaN(investment) || !date) {
            alert(translateText("Please fill all fields (Name, Investment, Date) with valid values."));
            return;
        }

        const newParticipant = {
            id: Date.now(), // Assign a unique ID
            name: name,
            paymentValidated: false,
            investment: investment,
            gain: 0, // Initial gain is 0, will be updated if they win
            date: date,
            paymentMethod: paymentMethod
        };

        // Add participant to the global list and to the current rotation queue
        participants.push(newParticipant);
        rotationMembersQueue.push(newParticipant);

        saveParticipants(); // Save updated global list and rotation queue
        renderParticipantsTable(); // Re-render the main table

        let currentBatchSize = rotationMembersQueue.length;
        let isWinningConditionMet = false;

        // Condition for winning: First 10, then every 2
        if (participants.length <= 10 && currentBatchSize === 10) {
            isWinningConditionMet = true;
        } else if (participants.length > 10 && currentBatchSize === 2) {
            isWinningConditionMet = true;
        }

        if (isWinningConditionMet) {
            // Calculate total investment of the current batch for payout calculation
            const totalInvestmentForCurrentPayout = rotationMembersQueue.reduce((sum, p) => sum + p.investment, 0);

            // The effective total pool for this calculation includes the new investments AND the accumulated rollover.
            const currentTotalSystemFunds = totalInvestmentForCurrentPayout + rolloverFund;

            const winnerGain = (currentTotalSystemFunds - (currentTotalSystemFunds / 3)) + 0.3;

            // Select winner: Assuming the last person added to the current batch is the winner
            const winner = rotationMembersQueue[rotationMembersQueue.length - 1];

            // Update winner's gain in the global participants array
            const globalWinnerIndex = participants.findIndex(p => p.id === winner.id);
            if (globalWinnerIndex !== -1) {
                participants[globalWinnerIndex].gain = winnerGain;
            }

            // Calculate the amount that the system "keeps" from this `currentTotalSystemFunds`
            // (1/3 of the total, minus 10% fee on that 1/3)
            const amountRetainedBySystem = (currentTotalSystemFunds / 3) - (currentTotalSystemFunds / 3 * 0.10);

            // Update the `rolloverFund` for the next cycle:
            // It's the `currentTotalSystemFunds`
            // MINUS the `winnerGain`
            // PLUS the `amountRetainedBySystem` (which represents the 1/3 portion that is supposed to stay in the system).
            // This way, the rollover fund accounts for both money paid out and money explicitly kept.
            rolloverFund = currentTotalSystemFunds - winnerGain;
            rolloverFund += amountRetainedBySystem; // Add the portion that should fuel future payouts

            // Ensure rolloverFund doesn't go negative if there's a rounding issue or small amounts
            if (rolloverFund < 0) {
                rolloverFund = 0;
            }

            alert(`${translateText("Winner! Gain for this rotation:")} ${winnerGain.toFixed(2)} ${winner.paymentMethod} ${translateText("for")} ${winner.name}!`);

            // Reset the queue for the next batch of participants
            rotationMembersQueue = [];

            saveParticipants(); // Save updated participants (with winner's gain) and new rollover state
            renderParticipantsTable(); // Re-render to show winner's updated gain
            // renderStats() is called by renderParticipantsTable()
        } else {
            alert(`${translateText("Participant added to rotation. Current count:")} ${currentBatchSize}${translateText(" for this winner cycle.")}`);
        }

        // Clear inputs after adding to rotation
        document.getElementById("participantName").value = '';
        document.getElementById("participantInvestment").value = '';
        document.getElementById("participantDate").value = '';
    }

    function togglePaymentValidation(participantId) {
        const participantIndex = participants.findIndex(p => p.id === participantId);
        if (participantIndex !== -1) {
            participants[participantIndex].paymentValidated = !participants[participantIndex].paymentValidated;
            saveParticipants();
            renderParticipantsTable();
            alert(translateText("Payment validated successfully!"));
        } else {
            alert(translateText("Cannot validate payment, participant not found."));
        }
    }

    function nextDay() {
        // This function can be used to signify a new "day" in the rotation,
        // though the current rotation logic is based on participant count.
        // It might be used for daily reporting or other time-based actions.
        alert(translateText("Next day initiated (functionality to be defined)."));
    }

    function renderParticipantsTable() {
        const tableBody = document.getElementById('participantsTableBody');
        tableBody.innerHTML = ''; // Clear existing rows
        let totalInvestment = 0;
        let totalGain = 0;

        participants.forEach((participant, index) => {
            const row = tableBody.insertRow();
            row.insertCell(0).textContent = index + 1; // N¬∞
            row.insertCell(1).textContent = participant.name; // Name
            row.insertCell(2).textContent = participant.paymentValidated ? '‚úÖ' : '‚ùå'; // Paiement Valid√©
            row.insertCell(3).textContent = participant.investment.toFixed(2); // Investment (‚Ç¨)
            row.insertCell(4).textContent = participant.gain.toFixed(2); // Gain (‚Ç¨)
            row.insertCell(5).textContent = participant.date; // Date
            row.insertCell(6).textContent = (participant.investment + participant.gain).toFixed(2); // Total (‚Ç¨)
            row.insertCell(7).textContent = translateText(participant.paymentMethod); // Payment Method

            const actionsCell = row.insertCell(8);
            const validateButton = document.createElement('button');
            validateButton.textContent = translateText('Validate');
            validateButton.className = 'btn-success action-buttons';
            validateButton.onclick = () => togglePaymentValidation(participant.id);
            actionsCell.appendChild(validateButton);

            const deleteButton = document.createElement('button');
            deleteButton.textContent = translateText('Delete');
            deleteButton.className = 'btn-danger action-buttons';
            deleteButton.onclick = () => deleteParticipant(participant.id, participant.name);
            actionsCell.appendChild(deleteButton);

            totalInvestment += participant.investment;
            totalGain += participant.gain;
        });
        renderStats(totalInvestment, totalGain); // Call renderStats here to update after table renders
        // Removed applyTranslations() from here to prevent recursion
    }

    function renderStats(totalInvestment = 0, totalGain = 0) {
        const statsDiv = document.getElementById('stats');
        statsDiv.innerHTML = `
            <p><strong data-translate="Total Participants">Total Participants</strong>: ${participants.length}</p>
            <p><strong data-translate="Total Investment (‚Ç¨)">Total Investment (‚Ç¨)</strong>: ${totalInvestment.toFixed(2)}</p>
            <p><strong data-translate="Total Gain (‚Ç¨)">Total Gain (‚Ç¨)</strong>: ${totalGain.toFixed(2)}</p>
            <p><strong data-translate="Current Rollover Fund (‚Ç¨)">Current Rollover Fund (‚Ç¨)</strong>: ${rolloverFund.toFixed(2)}</p>
        `;
        // Removed applyTranslations() from here to prevent recursion
    }


    function deleteParticipant(id, name) {
        if (confirm(`${translateText("Are you sure you want to delete")} ${name} ${translateText("and all its data?")}`)) {
            participants = participants.filter(p => p.id !== id);
            // Also remove from rotationMembersQueue if present
            rotationMembersQueue = rotationMembersQueue.filter(p => p.id !== id);
            saveParticipants();
            renderParticipantsTable();
        }
    }

    function resetData() {
        if (confirm(translateText("This will reset all data. Are you sure?"))) {
            localStorage.clear(); // Clears all local storage
            participants = [];
            rotationMembersQueue = [];
            rolloverFund = 0;
            supervisors = [];
            teamLeaders = [];
            renderParticipantsTable();
            renderStats();
            alert(translateText("Data reset successfully!"));
        }
    }

    // --- Export Functions ---
    function exportToExcel() {
        const ws_data = [
            [translateText("N¬∞"), translateText("Name"), translateText("Paiement Valid√©"), translateText("Investment (‚Ç¨)"), translateText("Gain (‚Ç¨)"), translateText("Date"), translateText("Total (‚Ç¨)"), translateText("Payment Method")]
        ];
        participants.forEach((p, index) => {
            ws_data.push([
                index + 1,
                p.name,
                p.paymentValidated ? 'Yes' : 'No',
                p.investment.toFixed(2),
                p.gain.toFixed(2),
                p.date,
                (p.investment + p.gain).toFixed(2),
                p.paymentMethod
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Participants Data");
        XLSX.writeFile(wb, "participants_data.xlsx");
    }

    function exportToExcelTL() {
        // This function is for Team Leader specific export, currently mirrors general export
        // You would modify this to export only data relevant to a specific Team Leader
        exportToExcel(); // Placeholder: currently calls the general export
        alert(translateText("Export History (TL) functionality will be specific to Team Leader data."));
    }

    // --- Supervisor and Team Leader Functions ---
    function ajouterSuperviseur() {
        const newSupervisor = {
            id: Date.now(),
            name: "Supervisor " + (supervisors.length + 1),
            // Add other supervisor specific data if needed
        };
        supervisors.push(newSupervisor);
        saveParticipants(); // Save updated supervisors list
        renderSuperviseurList();
        alert(translateText("Supervisor added successfully!"));
    }

    function renderSuperviseurList() {
        const listDiv = document.getElementById('superviseurList');
        listDiv.innerHTML = '<h4>' + translateText("Supervisors") + '</h4>';
        if (supervisors.length === 0) {
            listDiv.innerHTML += '<p>' + translateText("No supervisor selected.") + '</p>';
            return;
        }
        supervisors.forEach(s => {
            listDiv.innerHTML += `<p>${s.name}</p>`;
        });
    }

    function ajouterTeamLeader() {
        const tlName = document.getElementById('teamLeaderName').value.trim();
        if (!tlName) {
            alert(translateText("Enter a name for the Team Leader."));
            return;
        }
        const newTeamLeader = {
            id: Date.now(),
            name: tlName,
            // Add other Team Leader specific data like assigned participants etc.
        };
        teamLeaders.push(newTeamLeader);
        saveParticipants();
        renderTeamLeaderList();
        document.getElementById('teamLeaderName').value = ''; // Clear input
        alert(translateText("Team Leader added successfully!"));
    }

    function renderTeamLeaderList() {
        const listDiv = document.getElementById('teamLeaderList');
        listDiv.innerHTML = '<h4>' + translateText("Team Leaders") + '</h4>';
        if (teamLeaders.length === 0) {
            listDiv.innerHTML += '<p>' + translateText("No Team Leader selected.") + '</p>';
            return;
        }
        teamLeaders.forEach(tl => {
            listDiv.innerHTML += `<p>${tl.name}</p>`;
        });
    }

    function nextDayTL() {
        alert(translateText("Next Day (TL) functionality to be implemented."));
    }

    // Example of a function to send a contact message via EmailJS (if needed)
    function sendContactForm() {
        const templateParams = {
            from_name: "Admin Panel User", // You might want to make this configurable
            message: "An action request from the admin panel.", // Customize message
        };

        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_CONTACT_TEMPLATE_ID, templateParams)
            .then(function(response) {
                alert(translateText('Action request sent.'));
            }, function(error) {
                console.error('Failed to send action request:', error);
                alert(translateText('Failed to send action request.'));
            });
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        applyTranslations(); // Apply translations on initial load for static elements
        if (localStorage.getItem('loggedIn') === 'true') {
            document.getElementById('authCard').style.display = 'none';
            document.getElementById('codeCard').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadParticipants();
            renderParticipantsTable(); // This will call renderStats
            renderSuperviseurList();
            renderTeamLeaderList();
        } else {
            document.getElementById('authCard').style.display = 'block';
            document.getElementById('codeCard').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
        }
    });

</script>
</body>
</html>
